<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>SPIDER BOT - Login & Predictions</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {margin:0;padding:0;height:100vh;background:#0a0a0a;overflow:hidden;font-family:'Cairo',sans-serif;color:white;display:flex;justify-content:center;align-items:center;}
.container {background: rgba(0,0,0,0.85); padding:40px 30px; border-radius:20px; box-shadow:0 0 30px rgba(0,0,0,0.5); width:100%; max-width:400px; text-align:center;}
input {width:100%; padding:12px; margin:12px 0; border-radius:10px; border:none; outline:none; font-size:16px; box-sizing:border-box;}
button {width:100%; padding:12px; border:none; border-radius:10px; background:#ff3c00; color:#fff; font-size:18px; cursor:pointer; margin-top:10px; transition:0.3s;}
button:hover {background:#e23200;}
.error {color:#ff6b6b;margin-top:10px;}
.success {color:#4ef76f;margin-top:10px;}
#dashboard {display:none; flex-direction:column; align-items:center; width:100%;}
/* SPIDER BOT Dashboard Styles */
.logo {text-align:center;margin-top:20px; z-index:1;}
.logo svg {width:100px;height:100px; filter: drop-shadow(0 0 20px #ff0033); animation:pulse 2s infinite ease-in-out;}
.logo-text {font-family:'Orbitron',sans-serif; font-size:32px; font-weight:900; letter-spacing:2px; color:#ff0033; text-shadow:0 0 25px #ff0033; margin-top:5px;}
@keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.07);}100%{transform:scale(1);}}
#circleBox{margin-top:20px; z-index:1; position:relative; display:flex; justify-content:center; align-items:center;}
.circle{width:200px; height:200px; border-radius:50%; display:flex; flex-direction:column; justify-content:center; align-items:center; box-shadow:0 0 30px #00ffdd,0 0 70px #00ffdd inset,0 0 100px #00ffdd; backdrop-filter: blur(4px); transition: all 0.5s ease; position:relative;}
.value{font-size:50px; font-weight:800; text-shadow:0 0 12px #000;}
.subtitle{font-size:18px; opacity:0.85; margin-top:5px;}
#chartContainer{width:90%; max-width:800px; margin-top:30px; background: rgba(0,0,0,0.5); padding:20px; border-radius:15px; backdrop-filter: blur(5px); box-shadow:0 0 25px #00ffdd55 inset;}
</style>
</head>
<body>

<!-- Login Form -->
<div class="container" id="loginContainer">
  <div class="logo-text">SPIDER BOT CRACH</div>
  <input type="text" id="userID" placeholder="User ID (10 أرقام)">
  <input type="text" id="activationCode" placeholder="كود التفعيل">
  <button id="submitBtn">دخول</button>
  <div class="error" id="errorMsg"></div>
  <div class="success" id="successMsg"></div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="logo">
    <svg viewBox="0 0 200 200" fill="none">
      <circle cx="100" cy="100" r="90" stroke="#ff0033" stroke-width="6" opacity="0.15"/>
      <ellipse cx="100" cy="105" rx="28" ry="35" fill="#ff0033"/>
      <circle cx="100" cy="60" r="20" fill="#ff0033"/>
      <circle cx="90" cy="58" r="5" fill="white"/>
      <circle cx="110" cy="58" r="5" fill="white"/>
      <path d="M120 75 C150 60 170 40 180 20" stroke="#ff0033" stroke-width="6" stroke-linecap="round"/>
      <path d="M120 95 C155 90 175 80 188 70" stroke="#ff0033" stroke-width="6" stroke-linecap="round"/>
      <path d="M120 115 C155 130 175 145 188 160" stroke="#ff0033" stroke-width="6" stroke-linecap="round"/>
      <path d="M80 75 C50 60 30 40 20 20" stroke="#ff0033" stroke-width="6" stroke-linecap="round"/>
      <path d="M80 95 C45 90 25 80 12 70" stroke="#ff0033" stroke-width="6" stroke-linecap="round"/>
      <path d="M80 115 C45 130 25 145 12 160" stroke="#ff0033" stroke-width="6" stroke-linecap="round"/>
    </svg>
    <div class="logo-text">SPIDER BOT CRACH</div>
  </div>

  <!-- Prediction Circle -->
  <div id="circleBox">
    <div class="circle" style="background-color:#00ffdd;">
      <div class="value">…</div>
      <div class="subtitle">في انتظار التوقع</div>
    </div>
  </div>

  <!-- Chart -->
  <div id="chartContainer">
    <canvas id="predictionChart"></canvas>
  </div>

  <!-- Audio -->
  <audio id="pingSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBIwo_5BOqc1P9CO1l3054Gc3S9h1vqHmY",
  authDomain: "codesspider-4ba2b.firebaseapp.com",
  projectId: "codesspider-4ba2b",
  storageBucket: "codesspider-4ba2b.appspot.com",
  messagingSenderId: "20155738358",
  appId: "1:20155738358:web:115ab5d0de395a21e824d7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== Login Logic =====
const userIDInput = document.getElementById('userID');
const activationCodeInput = document.getElementById('activationCode');
const submitBtn = document.getElementById('submitBtn');
const errorMsg = document.getElementById('errorMsg');
const successMsg = document.getElementById('successMsg');

submitBtn.addEventListener('click', async ()=>{
  const userID = userIDInput.value.trim();
  const code = activationCodeInput.value.trim().toUpperCase();
  errorMsg.textContent=''; successMsg.textContent='';

  if(!/^\d{10}$/.test(userID)){ errorMsg.textContent="User ID يجب أن يكون 10 أرقام"; return; }
  if(!code){ errorMsg.textContent="أدخل كود التفعيل"; return; }

  try{
    const q = query(collection(db,'codes'), where('activationCode','==',code));
    const snap = await getDocs(q);

    if(snap.empty){ errorMsg.textContent="الكود غير صحيح"; return; }

    let valid=false, docId='', codeData={};
    snap.forEach(docSnap=>{
      const data = docSnap.data();
      const now = new Date();
      if(!data.used && new Date(data.validUntil) >= now){
        valid=true; docId = docSnap.id; codeData = data;
      }
    });

    if(!valid){ errorMsg.textContent="الكود مستخدم أو انتهت صلاحيته"; return; }

    // تحديث حالة الكود ليصبح مستخدم
    await updateDoc(doc(db,'codes',docId),{used:true});

    // حفظ User ID في localStorage فقط
    localStorage.setItem('currentUser', JSON.stringify({userID, activationCode:code}));

    successMsg.textContent="تم تسجيل الدخول بنجاح!";
    setTimeout(()=>{
      document.getElementById('loginContainer').style.display='none';
      document.getElementById('dashboard').style.display='flex';
      initSpiderBot(userID);
    },1000);

  }catch(err){console.error(err); errorMsg.textContent="حدث خطأ، حاول مرة أخرى";}
});

// ===== Spider Bot Dashboard =====
function initSpiderBot(userID){
  console.log("User ID:", userID); // يمكنك استخدامه في التوقعات
  const ws=new WebSocket("wss://thanos-icucrashaiwebsocketvaule.onrender.com/");
  const circleBox=document.getElementById("circleBox");
  const ping=document.getElementById('pingSound');
  const predictionValues=[];
  const maxHistory=12;

  function getCircleStyle(value){
    let color='#ff0033', scale=1;
    if(value<1.5){color='#ff0033'; scale=0.85;}
    else if(value<3){color='#ffcc00'; scale=1;}
    else{color='#00ff55'; scale=1.2;}
    return {color, scale};
  }

  function showPrediction(value){
    const style=getCircleStyle(value);
    circleBox.innerHTML=`
      <div class="circle" style="background:${style.color}; transform:scale(${style.scale}); box-shadow:0 0 40px ${style.color},0 0 90px ${style.color} inset,0 0 140px ${style.color};">
        <div class="value">${value}</div>
        <div class="subtitle">توقع جديد</div>
      </div>`;
    addHistoryPoints(value);
    addToChart(value);
    ping.play();
  }

  function addHistoryPoints(value){
    predictionValues.push(value);
    if(predictionValues.length>maxHistory) predictionValues.shift();
    document.querySelectorAll('.pointHistory').forEach(p=>p.remove());
    const radius=120;
    predictionValues.forEach((v,i)=>{
      const angle=(i/predictionValues.length)*2*Math.PI - Math.PI/2;
      const x=radius*Math.cos(angle);
      const y=radius*Math.sin(angle);
      const point=document.createElement('div');
      point.classList.add('pointHistory');
      point.style.position='absolute';
      point.style.width='10px'; point.style.height='10px';
      point.style.borderRadius='50%';
      point.style.background='#00ffdd';
      point.style.opacity=0.8;
      point.style.left=`calc(50% + ${x}px - 5px)`;
      point.style.top=`calc(50% + ${y}px - 5px)`;
      circleBox.appendChild(point);
    });
  }

  const ctx=document.getElementById('predictionChart').getContext('2d');
  const chartData={labels:[], datasets:[{label:'', data:[], borderColor:'#00ffdd', backgroundColor:'rgba(0,255,221,0.1)', tension:0.4, fill:true, pointRadius:5, pointHoverRadius:7, borderWidth:3, pointBackgroundColor:'#00ffdd'}]};
  const predictionChart=new Chart(ctx,{type:'line',data:chartData,options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(0,255,221,0.1)'}, ticks:{color:'#00ffdd'}},y:{grid:{color:'rgba(0,255,221,0.1)'}, ticks:{color:'#00ffdd'}}}}});
  function addToChart(value){if(chartData.labels.length>=20){chartData.labels.shift(); chartData.datasets[0].data.shift();} chartData.labels.push(''); chartData.datasets[0].data.push(value); predictionChart.update();}

  ws.onopen=()=>{console.log("Connected");};
  ws.onmessage=(event)=>{
    let text=event.data;
    const m=text.match(/(\d+(\.\d+)?)/);
    if(m) showPrediction(parseFloat(m[1]));
    else showPrediction("؟");
  };
}
</script>

</body>
</html>
